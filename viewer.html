<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Bulukumba GeoViewer</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css">
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: #f4f8fb; }
    #map { width: 100%; height: 100%; }

    /* HEADER */
    #header {
      position: absolute; top: 10px; left: 10px;
      background: linear-gradient(90deg, rgba(0,60,136,0.95), rgba(0,128,128,0.95));
      color: white; padding: 8px 14px;
      border-radius: 6px; display: flex; align-items: center; gap: 10px;
      z-index: 1000; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    #header img { height: 40px; }
    #header strong { font-size: 18px; }
    #header span.tagline {
      font-size: 12px; font-style: italic; opacity: 0.9;
    }

    /* DROPZONE */
    #dropzone {
      position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
      background: rgba(0,128,128,0.85); color: white; padding: 8px 12px;
      border-radius: 4px; z-index: 1000; font-size: 14px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    /* LEGEND */
    #legend {
      position: absolute; bottom: 30px; right: 10px;
      background: rgba(255,255,255,0.95); padding: 8px;
      border-radius: 4px; font-size: 12px; max-width: 200px; z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #legend div { margin-bottom: 4px; display: flex; align-items: center; }
    #legend span.color-box {
      display: inline-block; width: 16px; height: 16px; margin-right: 6px;
      border: 1px solid #555;
    }

    /* PROGRESS BAR */
    #progress-container {
      position: absolute; top: 110px; left: 50%; transform: translateX(-50%);
      width: 300px; background: rgba(255,255,255,0.95);
      border-radius: 4px; padding: 6px; z-index: 2000;
      display: none; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #progress-bar {
      width: 0%; height: 12px; background: linear-gradient(90deg, #007BFF, #00b3b3);
      border-radius: 4px; transition: width 0.2s;
    }
    #progress-text {
      font-size: 12px; text-align: center; margin-top: 4px;
    }

    /* WATERMARK */
    #watermark {
      position: absolute; bottom: 6px; left: 10px;
      font-size: 11px; color: rgba(0,0,0,0.6);
      background: rgba(255,255,255,0.6); padding: 2px 6px;
      border-radius: 3px;
    }
  </style>
</head>
<body>
<div id="header">
  <img src="https://upload.wikimedia.org/wikipedia/commons/0/0b/Lambang_Kabupaten_Bulukumba.png" alt="Logo Bulukumba">
  <div>
    <strong>Bulukumba GeoViewer</strong><br>
    <span class="tagline">"Bumi Panrita Lopi â€“ Data untuk Semua"</span>
  </div>
</div>

<div id="dropzone">Tarik & letakkan file GeoJSON / SHP / ZIP dan/atau SLD di sini</div>
<div id="map"></div>
<div id="legend"></div>

<!-- Progress bar -->
<div id="progress-container">
  <div id="progress-bar"></div>
  <div id="progress-text">0%</div>
</div>

<!-- Watermark -->
<div id="watermark">Design by callunk76</div>

<script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ol-sld@latest/dist/ol-sld.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/shpjs@latest/dist/shp.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/proj4@latest/dist/proj4.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epsg-index@latest/epsg-index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epsg-index@latest/epsg-index-all.js"></script>

<script>
  let geojsonData = null;
  let sldText = null;
  let vectorLayer = null;
  let detectedProjection = 'EPSG:4326';

  const map = new ol.Map({
    target: 'map',
    layers: [
      new ol.layer.Tile({ source: new ol.source.OSM() })
    ],
    view: new ol.View({
      center: ol.proj.fromLonLat([120, -5.5]),
      zoom: 10
    })
  });

  function rgbaToCss(color) {
    if (Array.isArray(color)) {
      return `rgba(${color.join(',')})`;
    }
    return color || '#ccc';
  }

  function renderLayer() {
    if (!geojsonData) return;

    let styleFunction = defaultStyle();

    if (sldText) {
      try {
        const sldObject = SLDReader.Reader(sldText);
        const layerNames = Object.keys(sldObject.namedLayers);
        console.log("Layer di SLD:", layerNames);
        if (layerNames.length > 0) {
          const style = SLDReader.getStyle(sldObject, layerNames[0]);
          styleFunction = feature => SLDReader.olStyle(style, feature);
          buildLegendFromSLD(sldObject);
        }
      } catch (err) {
        console.error("Gagal parse SLD:", err);
        clearLegend();
      }
    } else {
      clearLegend();
    }

    if (vectorLayer) map.removeLayer(vectorLayer);

    vectorLayer = new ol.layer.Vector({
      source: new ol.source.Vector({
        features: new ol.format.GeoJSON().readFeatures(geojsonData, {
          dataProjection: detectedProjection,
          featureProjection: 'EPSG:3857'
        })
      }),
      style: styleFunction
    });

    map.addLayer(vectorLayer);
    map.getView().fit(vectorLayer.getSource().getExtent(), { padding: [20,20,20,20] });
    hideProgress();
  }

  function defaultStyle() {
    return new ol.style.Style({
      stroke: new ol.style.Stroke({ color: '#007BFF', width: 2 }),
      fill: new ol.style.Fill({ color: 'rgba(0,123,255,0.2)' }),
      image: new ol.style.Circle({
        radius: 5,
        fill: new ol.style.Fill({ color: '#FF4136' }),
        stroke: new ol.style.Stroke({ color: 'white', width: 1 })
      })
    });
  }

  function buildLegendFromSLD(sldObject) {
    const legendDiv = document.getElementById('legend');
    legendDiv.innerHTML = '<strong>Legenda</strong><br>';
    const namedLayer = Object.values(sldObject.namedLayers)[0];
    const userStyles = namedLayer.userStyles || [];
    userStyles.forEach(style => {
      style.rules.forEach(rule => {
        let color = '#ccc';
        if (rule.symbolizers && rule.symbolizers.length > 0) {
          const sym = rule.symbolizers[0];
          if (sym.Fill && sym.Fill.color) color = rgbaToCss(sym.Fill.color);
          if (sym.Stroke && sym.Stroke.color) color = rgbaToCss(sym.Stroke.color);
        }
        const label = rule.title || rule.name || 'Tanpa label';
        const item = document.createElement('div');
        const colorBox = document.createElement('span');
        colorBox.className = 'color-box';
        colorBox.style.background = color;
        const text = document.createElement
                text.textContent = label;
        item.appendChild(colorBox);
        item.appendChild(text);
        legendDiv.appendChild(item);
      });
    });
  }

  function clearLegend() {
    document.getElementById('legend').innerHTML = '';
  }

  function showProgress() {
    document.getElementById('progress-container').style.display = 'block';
    updateProgress(0);
  }

  function updateProgress(percent) {
    document.getElementById('progress-bar').style.width = percent + '%';
    document.getElementById('progress-text').textContent = percent + '%';
  }

  function hideProgress() {
    document.getElementById('progress-container').style.display = 'none';
  }

  document.addEventListener('dragover', e => e.preventDefault());
  document.addEventListener('drop', e => {
    e.preventDefault();
    for (const file of e.dataTransfer.files) {
      const reader = new FileReader();

      if (file.name.toLowerCase().endsWith('.geojson') || file.name.toLowerCase().endsWith('.json')) {
        showProgress();
        reader.onprogress = evt => {
          if (evt.lengthComputable) {
            updateProgress(Math.round((evt.loaded / evt.total) * 100));
          }
        };
        reader.onload = evt => {
          try {
            geojsonData = JSON.parse(evt.target.result);
            detectedProjection = 'EPSG:4326';
            renderLayer();
          } catch (err) {
            alert("GeoJSON tidak valid!");
            hideProgress();
          }
        };
        reader.readAsText(file);

      } else if (file.name.toLowerCase().endsWith('.sld')) {
        showProgress();
        reader.onprogress = evt => {
          if (evt.lengthComputable) {
            updateProgress(Math.round((evt.loaded / evt.total) * 100));
          }
        };
        reader.onload = evt => {
          sldText = evt.target.result;
          renderLayer();
        };
        reader.readAsText(file);

      } else if (file.name.toLowerCase().endsWith('.zip') || file.name.toLowerCase().endsWith('.shp')) {
        showProgress();
        shp(file).then(geojson => {
          geojsonData = geojson;
          detectedProjection = 'EPSG:4326';
          updateProgress(100);
          renderLayer();
        }).catch(err => {
          console.error("Gagal membaca SHP/ZIP:", err);
          alert("File SHP/ZIP tidak valid atau tidak lengkap.");
          hideProgress();
        });
      }
    }
  });
</script>
</body>
</html>
